// Generated by CoffeeScript 1.9.3
var getDBvalue, getformvalue, getinputname, getkeyvalue, htmlstring, inputs, judgeother, putmodel, value;

getkeyvalue = function(url) {
  return $.ajax({
    url: url,
    dataType: 'json',
    async: false
  }).done(function(data) {
    return data;
  }).fail(function() {
    return alert("获取失败！请刷新页面");
  }).always(function() {
    return console.log("complete");
  });
};

getDBvalue = function(url, array) {
  return $.ajax({
    url: url,
    dataType: 'json',
    async: true
  }).done(function(data) {
    var a, checkother, i, inputvalue, ivalue, j, k, len, match, ov, result, v, v1;
    for (k in data) {
      v = data[k];
      if (k === 'id') {
        continue;
      }
      a = $("#" + k);
      if (a.length > 0) {
        a.val(v);
      } else {
        match = /^\&+/g;
        result = match.test(v);
        if (result) {
          v1 = v.split('&');
        } else {
          v1 = [v];
        }
        ivalue = [];
        for (j = 0, len = v1.length; j < len; j++) {
          i = v1[j];
          checkother = /\_+/g;
          result = checkother.test(i);
          if (result) {
            ov = i.split('_');
            inputvalue = ov[1];
            ivalue.push(ov[0]);
            $("#" + k + "_other").css('display', 'inline-block');
            $("#" + k + "_other").val(inputvalue);
          } else {
            ivalue.push(i);
          }
        }
        $("select[name=" + k + "]").val(ivalue);
      }
    }
    return jQuery.getScript("/script/chosen.jquery.js").done(function() {
      var dom, l, len1, ref, results;
      $('.chosen-select').chosen();
      ref = $("select");
      results = [];
      for (l = 0, len1 = ref.length; l < len1; l++) {
        dom = ref[l];
        results.push(judgeother(dom));
      }
      return results;
    }).fail(function() {
      return alert("动态脚本加载失败");
    });
  }).fail(function() {
    return alert("数据库获取数据失败");
  }).always(function() {
    return console.log('DB_connect');
  });
};

putmodel = function(string, array, inputs) {
  var a, b, dataType, defaultvalue, fieldid, fieldname, html, id, itemlength, j, k, l, len, len1, mend, ref, ref1, ref2, ref3, str, title, v;
  html = "";
  for (j = 0, len = array.length; j < len; j++) {
    a = array[j];
    title = a.classname;
    id = a["class"];
    html = "<div id='" + id + "' class='J_content'> <h1>" + title + "</h1>";
    ref = a.childfield;
    for (l = 0, len1 = ref.length; l < len1; l++) {
      b = ref[l];
      fieldname = b.fieldname;
      fieldid = b.field;
      dataType = b.datatype;
      defaultvalue = b["default"];
      inputs = getinputname(fieldid, inputs);
      str = "";
      if (dataType === 'selecttext') {
        itemlength = b.items.length;
        str += "<select name='" + fieldid + "' class='chosen-select'>";
        mend = 0;
        ref1 = b.items;
        for (k in ref1) {
          v = ref1[k];
          if (v === "其他______" || v === "有______") {
            mend = 1;
            v = v.split('_')[0];
          }
          str += "<option value='" + v + "' class='" + fieldid + "_" + v + "'>" + v + "</option>";
        }
        str += "</select>";
        if (mend) {
          str += "<input type='text' class='otherdata' id='" + fieldid + "_other'/>";
          mend = 0;
        }
      } else if (dataType === 'mutiselecttext') {
        str += "<select name='" + fieldid + "' class='chosen-select' multiple>";
        mend = 0;
        ref2 = b.items;
        for (k in ref2) {
          v = ref2[k];
          if (v === "其他______") {
            mend = 1;
            v = v.split('_')[0];
          } else {
            mend = 0;
          }
          str += "<option value='" + v + "' class='" + fieldid + "_" + v + "'>" + v + "</option>";
        }
        str += "</select>";
        if (mend) {
          str += "<input type='text' class='otherdata' id='" + fieldid + "_other'/>";
        }
      } else if (dataType === 'bool') {
        ref3 = b.items;
        for (k in ref3) {
          v = ref3[k];
          str += "<input type='radio' class='" + fieldid + " selecttext' name='" + fieldid + "' value='" + k + "'/>" + v;
        }
      } else {
        str = "<input type='text' id='" + fieldid + "' name='" + fieldid + "' />";
      }
      html += "<div class='list'> <div class='note'> <h3>" + fieldname + "</h3> </div> <div class='input'> " + str + " </div> </div>";
    }
    html += "</div><div class='clear'></div><hr />";
    string += html;
  }
  $('#J_form').append(string);
  return inputs;
};

judgeother = function(point) {
  var id, input, type;
  id = point.id;
  type = point.name;
  input = $("#" + type + "_other");
  return $(point).on("change", function() {
    var flag, j, len, ref, t, value;
    flag = 0;
    value = $(point).val();
    if (value !== null) {
      if (typeof value === 'string') {
        if (value === "其他" || value === "有") {
          flag = 1;
        }
      } else if (typeof value === 'object') {
        ref = $(point).val();
        for (j = 0, len = ref.length; j < len; j++) {
          t = ref[j];
          if (t === "其他" || t === "有") {
            flag = 1;
          }
        }
      }
      if (flag) {
        return input.css('display', 'inline-block');
      } else {
        return input.css('display', 'none');
      }
    } else {
      return input.css('display', 'none');
    }
  });
};

getinputname = function(value, target) {
  var a, j, len;
  for (j = 0, len = target.length; j < len; j++) {
    a = target[j];
    if (a === value) {
      return target;
    }
  }
  target.push(value);
  return target;
};

getformvalue = function(array) {
  var a, data, flag, i, j, l, len, len1, str, target, targetclass, value;
  data = {
    "id": id
  };
  flag = 0;
  for (j = 0, len = array.length; j < len; j++) {
    i = array[j];
    target = $("input[name=" + i + "]");
    if (target.length < 1) {
      target = $("select[name=" + i + "]");
    }
    value = target.val();
    targetclass = target.attr('class');
    if (targetclass === 'chosen-select chzn-done') {
      if (typeof value === 'object') {
        str = '';
        if (value !== null) {
          for (l = 0, len1 = value.length; l < len1; l++) {
            a = value[l];
            if (a === "其他" || a === "有") {
              a += "_" + ($("#" + i + "_other").val());
            }
            str += "&" + a;
          }
          value = str;
        }
      } else if (typeof value === 'string') {
        if (value !== null) {
          if (value === "其他" || value === "有") {
            value += "_" + ($("#" + i + "_other").val());
          }
        }
      }
    }
    if (value === '' || value === null) {
      flag = 1;
    }
    data[i] = value;
  }
  return {
    data: data,
    flag: flag
  };
};

value = JSON.parse(getkeyvalue('/input/field').responseText);

htmlstring = "";

inputs = [];

inputs = putmodel(htmlstring, value, inputs);

getDBvalue("/input/get/" + id, inputs);

$('.save').on('click', function() {
  var target;
  target = getformvalue(inputs);
  value = target.data;
  console.log(value);
  return $.post('/input/update', value, function(data) {
    alert('保存成功');
    return getDBvalue("/input/get/" + id, inputs);
  });
});

$('.submit').on('click', function() {
  var target;
  target = getformvalue(inputs);
  value = target.data;
  if (target.flag) {
    return alert("没有填写完整，请检查");
  } else {
    return $.post('/input/update', value, function(data) {
      alert('提交成功');
      return location.href = "/";
    });
  }
});
